{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _extends from \"@babel/runtime/helpers/esm/extends\";\nimport _classCallCheck from \"@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/esm/createClass\";\nimport _inherits from \"@babel/runtime/helpers/esm/inherits\";\nimport _possibleConstructorReturn from \"@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime/helpers/esm/getPrototypeOf\";\nvar _jsxFileName = \"C:\\\\next-project\\\\src\\\\utils\\\\withApollo.tsx\";\nvar __jsx = React.createElement;\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = _getPrototypeOf(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = _getPrototypeOf(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return _possibleConstructorReturn(this, result); }; }\n\nfunction _isNativeReflectConstruct() { if (typeof Reflect === \"undefined\" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === \"function\") return true; try { Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {})); return true; } catch (e) { return false; } }\n\nimport React from 'react';\nimport initApollo from \"./initApollo\";\nimport cookie from 'cookie';\nimport PropTypes from 'prop-types';\nimport isBrowser from \"./isBrowser\";\nimport Head from 'next/head';\n\nfunction parseCookies(req) {\n  var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n  return cookie.parse(req ? req.headers.cookie || '' : document.cookie, options);\n}\n\nvar withApollo = function withApollo(App) {\n  var _class, _temp;\n\n  return _temp = _class = /*#__PURE__*/function (_React$Component) {\n    _inherits(WithData, _React$Component);\n\n    var _super = _createSuper(WithData);\n\n    function WithData(props) {\n      var _this;\n\n      _classCallCheck(this, WithData);\n\n      _this = _super.call(this, props); // `getDataFromTree` renders the component first, the client is passed off as a property.\n      // After that rendering is done using Next's normal rendering pipeline\n\n      _this.apolloClient = void 0;\n      _this.apolloClient = initApollo(props.router, props.apolloState, {\n        getToken: function getToken() {\n          return parseCookies().token;\n        }\n      });\n      return _this;\n    }\n\n    _createClass(WithData, [{\n      key: \"render\",\n      value: function render() {\n        return __jsx(App, _extends({}, this.props, {\n          apolloClient: this.apolloClient,\n          __self: this,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 98,\n            columnNumber: 11\n          }\n        }));\n      }\n    }], [{\n      key: \"getInitialProps\",\n      value: function () {\n        var _getInitialProps = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(ctx) {\n          var Component, router, _ctx$ctx, req, res, apollo, appProps, apolloState;\n\n          return _regeneratorRuntime.wrap(function _callee$(_context) {\n            while (1) {\n              switch (_context.prev = _context.next) {\n                case 0:\n                  Component = ctx.Component, router = ctx.router, _ctx$ctx = ctx.ctx, req = _ctx$ctx.req, res = _ctx$ctx.res;\n                  apollo = initApollo(router, {}, {\n                    getToken: function getToken() {\n                      return parseCookies(req).qid;\n                    }\n                  });\n                  ctx.ctx.apolloClient = apollo;\n                  appProps = {};\n\n                  if (!App.getInitialProps) {\n                    _context.next = 8;\n                    break;\n                  }\n\n                  _context.next = 7;\n                  return App.getInitialProps(ctx);\n\n                case 7:\n                  appProps = _context.sent;\n\n                case 8:\n                  if (!(res && res.finished)) {\n                    _context.next = 10;\n                    break;\n                  }\n\n                  return _context.abrupt(\"return\", {});\n\n                case 10:\n                  if (!isBrowser) {\n                    // Run all graphql queries in the component tree\n                    // and extract the resulting data\n                    // try {\n                    // \t// Run all GraphQL queries\n                    // \tawait getDataFromTree(\n                    // \t\t<App\n                    // \t\t\t{...appProps}\n                    // \t\t\tComponent={Component}\n                    // \t\t\trouter={router}\n                    // \t\t\tapolloClient={apollo}\n                    // \t\t/>\n                    // \t);\n                    // } catch (error) {\n                    // \t// Prevent Apollo Client GraphQL errors from crashing SSR.\n                    // \t// Handle them in components via the data.error prop:\n                    // \t// https://www.apollographql.com/docs/react/api/react-apollo.html#graphql-query-data-error\n                    // \tconsole.error('Error while running `getDataFromTree`', error);\n                    // }\n                    // getDataFromTree does not call componentWillUnmount\n                    // head side effect therefore need to be cleared manually\n                    Head.rewind();\n                  } // Extract query data from the Apollo's store\n\n\n                  apolloState = apollo.cache.extract();\n                  return _context.abrupt(\"return\", _objectSpread(_objectSpread({}, appProps), {}, {\n                    apolloState: apolloState\n                  }));\n\n                case 13:\n                case \"end\":\n                  return _context.stop();\n              }\n            }\n          }, _callee);\n        }));\n\n        function getInitialProps(_x) {\n          return _getInitialProps.apply(this, arguments);\n        }\n\n        return getInitialProps;\n      }()\n    }]);\n\n    return WithData;\n  }(React.Component), _class.displayName = \"WithData(\".concat(App.displayName, \")\"), _class.propTypes = {\n    apolloState: PropTypes.object.isRequired\n  }, _temp;\n};\n\nexport default withApollo;","map":{"version":3,"sources":["C:/next-project/src/utils/withApollo.tsx"],"names":["React","initApollo","cookie","PropTypes","isBrowser","Head","parseCookies","req","options","parse","headers","document","withApollo","App","props","apolloClient","router","apolloState","getToken","token","ctx","Component","res","apollo","qid","appProps","getInitialProps","finished","rewind","cache","extract","displayName","propTypes","object","isRequired"],"mappings":"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","sourcesContent":["import React from 'react';\r\nimport { ApolloClient, NormalizedCacheObject } from '@apollo/client';\r\nimport initApollo from './initApollo';\r\nimport cookie from 'cookie';\r\nimport PropTypes from 'prop-types';\r\nimport isBrowser from '~/utils/isBrowser';\r\nimport Head from 'next/head';\r\n\r\nfunction parseCookies(req?: any, options = {}) {\r\n\treturn cookie.parse(req ? req.headers.cookie || '' : document.cookie, options);\r\n}\r\n\r\nconst withApollo = (App: any) => {\r\n\r\n    return class WithData extends React.Component {\r\n        public static displayName = `WithData(${App.displayName})`;\r\n        public static propTypes = {\r\n\t\t\tapolloState: PropTypes.object.isRequired\r\n\t\t};\r\n\r\n        public static async getInitialProps(ctx: any) {\r\n\t\t\tconst {\r\n\t\t\t\tComponent,\r\n\t\t\t\trouter,\r\n\t\t\t\tctx: { req, res }\r\n\t\t\t} = ctx;\r\n\t\t\tconst apollo = initApollo(\r\n\t\t\t\trouter,\r\n\t\t\t\t{},\r\n\t\t\t\t{\r\n\t\t\t\t\tgetToken: () => parseCookies(req).qid\r\n\t\t\t\t}\r\n\t\t\t);\r\n\r\n\t\t\tctx.ctx.apolloClient = apollo;\r\n\r\n\t\t\tlet appProps = {};\r\n\t\t\tif (App.getInitialProps) {\r\n\t\t\t\tappProps = await App.getInitialProps(ctx);\r\n\t\t\t}\r\n\r\n\t\t\tif (res && res.finished) {\r\n\t\t\t\t// When redirecting, the response is finished.\r\n\t\t\t\t// No point in continuing to render\r\n\t\t\t\treturn {};\r\n\t\t\t}\r\n\r\n\t\t\tif (!isBrowser) {\r\n\t\t\t\t// Run all graphql queries in the component tree\r\n\t\t\t\t// and extract the resulting data\r\n\t\t\t\t// try {\r\n\t\t\t\t// \t// Run all GraphQL queries\r\n\t\t\t\t// \tawait getDataFromTree(\r\n\t\t\t\t// \t\t<App\r\n\t\t\t\t// \t\t\t{...appProps}\r\n\t\t\t\t// \t\t\tComponent={Component}\r\n\t\t\t\t// \t\t\trouter={router}\r\n\t\t\t\t// \t\t\tapolloClient={apollo}\r\n\t\t\t\t// \t\t/>\r\n\t\t\t\t// \t);\r\n\t\t\t\t// } catch (error) {\r\n\t\t\t\t// \t// Prevent Apollo Client GraphQL errors from crashing SSR.\r\n\t\t\t\t// \t// Handle them in components via the data.error prop:\r\n\t\t\t\t// \t// https://www.apollographql.com/docs/react/api/react-apollo.html#graphql-query-data-error\r\n\t\t\t\t// \tconsole.error('Error while running `getDataFromTree`', error);\r\n\t\t\t\t// }\r\n\r\n\t\t\t\t// getDataFromTree does not call componentWillUnmount\r\n\t\t\t\t// head side effect therefore need to be cleared manually\r\n\t\t\t\tHead.rewind();\r\n\t\t\t}\r\n\r\n\t\t\t// Extract query data from the Apollo's store\r\n\t\t\tconst apolloState = apollo.cache.extract();\r\n\r\n\t\t\treturn {\r\n\t\t\t\t...appProps,\r\n\t\t\t\tapolloState\r\n\t\t\t};\r\n        }\r\n        \r\n\r\n        public apolloClient: ApolloClient<NormalizedCacheObject>;\r\n\r\n        constructor(props: any) {\r\n\t\t\tsuper(props);\r\n\r\n\t\t\t// `getDataFromTree` renders the component first, the client is passed off as a property.\r\n\t\t\t// After that rendering is done using Next's normal rendering pipeline\r\n\t\t\tthis.apolloClient = initApollo(props.router, props.apolloState, {\r\n\t\t\t\tgetToken: () => {\r\n\t\t\t\t\treturn parseCookies().token;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tpublic render() {\r\n\t\t\treturn <App {...this.props} apolloClient={this.apolloClient} />;\r\n\t\t}\r\n    }    \r\n}\r\n\r\nexport default withApollo;"]},"metadata":{},"sourceType":"module"}